---
title: "Monitoramento da frota de ônibus"
Format: html
author: "Eduardo Nicolau Martins"
date: "2025-11-20"
image: "mapa.png"
categories: [API, Monitoramento, Ônibus, Python]
---

Neste post, vamos visualizar as paradas e a posição em tempo real dos ônibus da linha **8200-10 (Terminal Lapa - Terminal Pirituba)** utilizando a API Olho Vivo da SPTrans e a biblioteca Folium.

Os **pins azuis** representam as paradas oficiais da linha, e os **ícones vermelhos de ônibus** representam a localização exata dos veículos no momento em que este código foi executado.

```{python}
import requests
import folium
from IPython.display import display

TOKEN = "edc09af1758e3c9c2f062f80f3131da78d17ad4651f071c2b68ab7b426fe26d6"
LINHA_DESEJADA = "8200-10"

BASE_URL = "http://api.olhovivo.sptrans.com.br/v2.1"
session = requests.Session()

def autenticar():
    response = session.post(f"{BASE_URL}/Login/Autenticar?token={TOKEN}")
    return response.text == "true"

def obter_dados_inteligente(termo):
    response = session.get(f"{BASE_URL}/Linha/Buscar?termosBusca={termo}")
    linhas = response.json()
    if not linhas:
        return [], None
    for info in linhas:
        codigo = info['cl']
        resp_paradas = session.get(f"{BASE_URL}/Parada/BuscarParadasPorLinha?codigoLinha={codigo}")
        lista_paradas = resp_paradas.json()
        if len(lista_paradas) > 0:
            return lista_paradas, codigo
    return [], None

def obter_posicoes(codigo_linha):
    if codigo_linha is None:
        return []
    response = session.get(f"{BASE_URL}/Posicao/Linha?codigoLinha={codigo_linha}")
    dados = response.json()
    return dados['vs']


if autenticar():
    print("Autenticado! Buscando dados...")
    paradas, codigo_linha = obter_dados_inteligente(LINHA_DESEJADA)
    
    if codigo_linha:
        onibus_agora = obter_posicoes(codigo_linha)
    else:
        onibus_agora = []
        
    print(f"Resumo: {len(paradas)} paradas e {len(onibus_agora)} ônibus.")
    

    lat_mapa, lon_mapa = -23.5505, -46.6333
    if len(paradas) > 0:
        lat_mapa, lon_mapa = paradas[0]['py'], paradas[0]['px']
    elif len(onibus_agora) > 0:
        lat_mapa, lon_mapa = onibus_agora[0]['py'], onibus_agora[0]['px']
    

    mapa = folium.Map(location=[lat_mapa, lon_mapa], zoom_start=13)
    
    for p in paradas:
        folium.Marker(
            [p['py'], p['px']],
            popup=f"Parada: {p['np']}",
            icon=folium.Icon(color="blue", icon="info-sign")
        ).add_to(mapa)
        
    for bus in onibus_agora:
        folium.Marker(
            [bus['py'], bus['px']],
            popup=f"Prefixo: {bus['p']}",
            icon=folium.Icon(color="red", icon="bus", prefix="fa")
        ).add_to(mapa)
    
    display(mapa)

else:
    print("Erro na autenticação. Verifique o Token.")
```